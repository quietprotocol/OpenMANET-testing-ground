#!/bin/sh /etc/rc.common
#
# alfred-gpsd init script
# Starts alfred-gpsd in server mode to distribute GPS data via alfred
# Based on OpenWrt procd init script pattern
#

START=95
USE_PROCD=1
PROG=/usr/sbin/alfred-gpsd

start_service() {
    # Wait for alfred to be running (max 30 seconds)
    local retries=0
    while [ $retries -lt 30 ]; do
        if pgrep -f "/usr/sbin/alfred" > /dev/null; then
            break
        fi
        sleep 1
        retries=$((retries + 1))
    done
    
    # Wait for gpsd to be running (max 30 seconds)
    retries=0
    while [ $retries -lt 30 ]; do
        if pgrep -f "/usr/sbin/gpsd" > /dev/null; then
            break
        fi
        sleep 1
        retries=$((retries + 1))
    done
    
    # Start alfred-gpsd in server mode using procd
    # -s: server mode (reads from gpsd and updates alfred every 2 seconds)
    # -g: specify gpsd server (127.0.0.1:2947)
    procd_open_instance
    procd_set_param command "$PROG" -s -g 127.0.0.1:2947
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}

service_triggers() {
    # Restart alfred-gpsd when alfred or gpsd restart
    procd_add_reload_trigger "alfred"
    procd_add_reload_trigger "gpsd"
}

